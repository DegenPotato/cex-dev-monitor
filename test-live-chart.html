<!DOCTYPE html>
<html>
<head>
  <title>Live OHLCV Chart</title>
  <script src="https://unpkg.com/lightweight-charts@4.1.3/dist/lightweight-charts.standalone.production.js"></script>
  <style>
    body { font-family: 'Segoe UI', Arial; background: #0f172a; color: #e2e8f0; padding: 20px; margin: 0; }
    h1 { color: #f97316; margin: 0; }
    .container { max-width: 1800px; margin: 0 auto; }
    .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
    .status-badge { padding: 8px 16px; border-radius: 6px; font-size: 14px; font-weight: 600; }
    .status-badge.loading { background: #eab308; color: #000; }
    .status-badge.building { background: #3b82f6; color: white; }
    .status-badge.live { background: #10b981; color: white; animation: pulse 2s infinite; }
    
    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.7; }
    }
    
    .progress-container { background: #1e293b; padding: 20px; border-radius: 8px; margin-bottom: 20px; }
    .progress-bar { width: 100%; height: 8px; background: #334155; border-radius: 4px; overflow: hidden; }
    .progress-fill { height: 100%; background: #f97316; transition: width 0.3s; }
    .progress-text { margin-top: 10px; color: #94a3b8; font-size: 14px; }
    
    .token-info { background: #1e293b; padding: 15px; border-radius: 8px; margin-bottom: 20px; display: flex; align-items: center; gap: 15px; }
    .token-info img { width: 60px; height: 60px; border-radius: 8px; }
    .token-name { font-size: 24px; font-weight: 600; color: #f97316; }
    .token-symbol { color: #94a3b8; font-size: 14px; }
    
    .stats { display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; margin-bottom: 20px; }
    .stat { background: #1e293b; padding: 15px; border-radius: 8px; border: 1px solid #334155; }
    .stat-label { font-size: 12px; color: #94a3b8; }
    .stat-value { font-size: 24px; font-weight: bold; margin-top: 5px; }
    
    .charts-container { display: grid; grid-template-columns: 1fr 300px; gap: 20px; }
    .charts { display: flex; flex-direction: column; gap: 10px; }
    #mainChart { height: 500px; }
    #volumeChart { height: 150px; }
    #rsi14Chart { height: 150px; }
    #rsi2Chart { height: 150px; }
    
    .timeframe-selector { margin-bottom: 10px; display: flex; gap: 5px; }
    .tf-btn { background: #1e293b; color: #94a3b8; border: 1px solid #334155; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-size: 13px; }
    .tf-btn:hover { background: #334155; }
    .tf-btn.active { background: #f97316; color: white; border-color: #f97316; }
    
    .trade-feed { background: #1e293b; border-radius: 8px; padding: 15px; height: 900px; display: flex; flex-direction: column; }
    .trade-feed h3 { margin: 0 0 15px 0; color: #f97316; font-size: 14px; }
    .trade-list { flex: 1; overflow-y: auto; }
    .trade-item { padding: 8px; border-bottom: 1px solid #334155; font-size: 11px; animation: slideIn 0.3s; }
    .trade-item:hover { background: #334155; }
    .trade-item.new { background: #1e40af; }
    .trade-time { color: #64748b; font-size: 10px; }
    .trade-type { font-weight: bold; font-size: 11px; }
    .trade-type.buy { color: #10b981; }
    .trade-type.sell { color: #ef4444; }
    
    .trade-tags { display: flex; gap: 4px; flex-wrap: wrap; margin-top: 4px; }
    .tag { font-size: 9px; padding: 2px 6px; border-radius: 3px; font-weight: 600; text-transform: uppercase; }
    .tag.mint { background: #8b5cf6; color: white; }
    .tag.dev { background: #f59e0b; color: white; }
    .tag.bundler { background: #ec4899; color: white; }
    .tag.early_sniper { background: #ef4444; color: white; }
    .tag.block_0 { background: #7c3aed; color: white; }
    .tag.block_1 { background: #dc2626; color: white; }
    .tag.block_2 { background: #ea580c; color: white; }
    .tag.volume_bot { background: #64748b; color: white; }
    .tag.large_buy { background: #10b981; color: white; }
    .tag.large_sell { background: #f43f5e; color: white; }
    
    @keyframes slideIn {
      from { transform: translateX(-20px); opacity: 0; }
      to { transform: translateX(0); opacity: 1; }
    }
    
    .hidden { display: none; }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>ðŸš€ Live OHLCV Chart</h1>
      <div class="status-badge loading" id="statusBadge">Connecting...</div>
    </div>
    
    <div class="progress-container" id="progressContainer">
      <div class="progress-bar">
        <div class="progress-fill" id="progressFill" style="width: 0%"></div>
      </div>
      <div class="progress-text" id="progressText">Initializing...</div>
    </div>
    
    <div class="token-info hidden" id="tokenInfo">
      <img id="tokenImage" src="" alt="">
      <div>
        <div class="token-name" id="tokenName">Loading...</div>
        <div class="token-symbol" id="tokenSymbol">...</div>
      </div>
    </div>
    
    <div class="stats">
      <div class="stat">
        <div class="stat-label">Total Swaps</div>
        <div class="stat-value" id="totalSwaps">0</div>
      </div>
      <div class="stat">
        <div class="stat-label">Buys / Sells</div>
        <div class="stat-value" style="color: #10b981" id="totalBuys">0</div>
        <div class="stat-value" style="color: #ef4444" id="totalSells">0</div>
      </div>
      <div class="stat">
        <div class="stat-label">Volume (24h)</div>
        <div class="stat-value" style="color: #10b981" id="totalVolume">0 SOL</div>
      </div>
      <div class="stat">
        <div class="stat-label">Current Price</div>
        <div class="stat-value" id="currentPrice">-</div>
      </div>
    </div>
    
    <div class="timeframe-selector">
      <button class="tf-btn" onclick="switchTimeframe('1s')">1s</button>
      <button class="tf-btn" onclick="switchTimeframe('15s')">15s</button>
      <button class="tf-btn active" onclick="switchTimeframe('1m')">1m</button>
      <button class="tf-btn" onclick="switchTimeframe('5m')">5m</button>
      <button class="tf-btn" onclick="switchTimeframe('15m')">15m</button>
      <button class="tf-btn" onclick="switchTimeframe('1H')">1H</button>
      <button class="tf-btn" onclick="switchTimeframe('4H')">4H</button>
      <button class="tf-btn" onclick="switchTimeframe('1D')">1D</button>
    </div>
    
    <div class="charts-container">
      <div class="charts">
        <div id="mainChart"></div>
        <div id="volumeChart"></div>
        <div id="rsi14Chart"></div>
        <div id="rsi2Chart"></div>
      </div>
      
      <div class="trade-feed">
        <h3>ðŸ“Š Live Trade Feed</h3>
        <div class="trade-list" id="tradeList"></div>
      </div>
    </div>
  </div>
  
  <script>
    // Configuration - CHANGE THIS to your backend URL
    const WS_URL = 'ws://localhost:3000'; // Or use your backend WebSocket URL
    const TOKEN_MINT = 'ArD82QtzQg1Uke9BVUkHT6BAP5qeFTqstFaJGEiLpump';
    
    let ws = null;
    let chart = null;
    let volumeChart = null;
    let rsi14Chart = null;
    let rsi2Chart = null;
    let candleSeries = null;
    let volumeSeries = null;
    let rsi14Series = null;
    let rsi2Series = null;
    
    let currentTimeframe = '1m';
    let allCandles = {};
    let swaps = [];
    let buys = 0;
    let sells = 0;
    let totalVolume = 0;
    
    // Connect WebSocket
    function connect() {
      updateStatus('loading', 'Connecting to backend...');
      
      // For now, since we're testing, we'll use mock data mode
      // Once backend is ready, this will connect to actual WebSocket
      console.log('Would connect to:', WS_URL);
      
      // Mock: Simulate connection success
      setTimeout(() => {
        updateStatus('building', 'Building historical data...');
        loadMockData();
      }, 1000);
    }
    
    function updateStatus(type, text) {
      const badge = document.getElementById('statusBadge');
      badge.className = `status-badge ${type}`;
      badge.textContent = text === 'live' ? 'ðŸ”´ LIVE' : text;
    }
    
    function updateProgress(percent, message) {
      document.getElementById('progressFill').style.width = percent + '%';
      document.getElementById('progressText').textContent = message;
    }
    
    function showTokenInfo(metadata) {
      const container = document.getElementById('tokenInfo');
      container.classList.remove('hidden');
      
      if (metadata.image) {
        document.getElementById('tokenImage').src = metadata.image;
        document.getElementById('tokenImage').style.display = 'block';
      }
      
      document.getElementById('tokenName').textContent = metadata.name;
      document.getElementById('tokenSymbol').textContent = metadata.symbol;
    }
    
    function initializeCharts(candles) {
      // Hide progress
      document.getElementById('progressContainer').classList.add('hidden');
      
      // Create charts
      const mainContainer = document.getElementById('mainChart');
      chart = LightweightCharts.createChart(mainContainer, {
        width: mainContainer.clientWidth,
        height: 500,
        layout: { background: { color: '#1e293b' }, textColor: '#d1d5db' },
        grid: { vertLines: { color: '#334155' }, horzLines: { color: '#334155' } },
        timeScale: { timeVisible: true, secondsVisible: currentTimeframe.includes('s') }
      });
      
      candleSeries = chart.addCandlestickSeries({
        upColor: '#10b981',
        downColor: '#ef4444',
        borderVisible: false,
        wickUpColor: '#10b981',
        wickDownColor: '#ef4444'
      });
      
      // Volume chart
      const volumeContainer = document.getElementById('volumeChart');
      volumeChart = LightweightCharts.createChart(volumeContainer, {
        width: volumeContainer.clientWidth,
        height: 150,
        layout: { background: { color: '#1e293b' }, textColor: '#d1d5db' },
        grid: { vertLines: { color: '#334155' }, horzLines: { color: '#334155' } }
      });
      
      volumeSeries = volumeChart.addHistogramSeries({
        color: '#60a5fa',
        priceFormat: { type: 'volume' }
      });
      
      // RSI 14 chart
      const rsi14Container = document.getElementById('rsi14Chart');
      rsi14Chart = LightweightCharts.createChart(rsi14Container, {
        width: rsi14Container.clientWidth,
        height: 150,
        layout: { background: { color: '#1e293b' }, textColor: '#d1d5db' },
        grid: { vertLines: { color: '#334155' }, horzLines: { color: '#334155' } }
      });
      
      rsi14Series = rsi14Chart.addLineSeries({ color: '#f97316', lineWidth: 2 });
      
      // RSI 2 chart
      const rsi2Container = document.getElementById('rsi2Chart');
      rsi2Chart = LightweightCharts.createChart(rsi2Container, {
        width: rsi2Container.clientWidth,
        height: 150,
        layout: { background: { color: '#1e293b' }, textColor: '#d1d5db' },
        grid: { vertLines: { color: '#334155' }, horzLines: { color: '#334155' } }
      });
      
      rsi2Series = rsi2Chart.addLineSeries({ color: '#10b981', lineWidth: 2 });
      
      // Set initial data
      setChartData(currentTimeframe);
      
      updateStatus('live', 'LIVE');
    }
    
    function setChartData(timeframe) {
      const candles = allCandles[timeframe] || [];
      if (candles.length === 0) return;
      
      candleSeries.setData(candles);
      
      // Volume
      const volumeData = candles.map(c => ({
        time: c.time,
        value: c.volume,
        color: c.close >= c.open ? '#10b981' : '#ef4444'
      }));
      volumeSeries.setData(volumeData);
      
      // RSI
      const rsi14 = calculateRSI(candles, 14);
      const rsi2 = calculateRSI(candles, 2);
      rsi14Series.setData(rsi14);
      rsi2Series.setData(rsi2);
      
      // Update current price
      const lastCandle = candles[candles.length - 1];
      document.getElementById('currentPrice').textContent = lastCandle.close.toFixed(10);
    }
    
    function updateCandle(timeframe, candle) {
      if (timeframe !== currentTimeframe) return;
      
      candleSeries.update(candle);
      
      volumeSeries.update({
        time: candle.time,
        value: candle.volume,
        color: candle.close >= candle.open ? '#10b981' : '#ef4444'
      });
      
      // Update price
      document.getElementById('currentPrice').textContent = candle.close.toFixed(10);
    }
    
    function addTrade(swap) {
      swaps.unshift(swap); // Add to front
      if (swaps.length > 100) swaps.pop(); // Keep last 100
      
      if (swap.type === 'buy') buys++;
      else sells++;
      totalVolume += swap.solAmount;
      
      // Update stats
      document.getElementById('totalSwaps').textContent = (buys + sells).toLocaleString();
      document.getElementById('totalBuys').textContent = buys;
      document.getElementById('totalSells').textContent = sells;
      document.getElementById('totalVolume').textContent = totalVolume.toFixed(2) + ' SOL';
      
      // Add to feed
      const tradeList = document.getElementById('tradeList');
      const tradeItem = document.createElement('div');
      tradeItem.className = 'trade-item new';
      tradeItem.innerHTML = `
        <div class="trade-time">${new Date(swap.timestamp * 1000).toLocaleTimeString()}</div>
        <div class="trade-type ${swap.type}">${swap.type.toUpperCase()}</div>
        ${swap.tags ? `<div class="trade-tags">${swap.tags.map(tag => `<span class="tag ${tag.toLowerCase()}">${tag}</span>`).join('')}</div>` : ''}
        <div style="margin-top: 4px;">
          <div>Amount: ${swap.tokenAmount.toFixed(2)}</div>
          <div>Volume: ${swap.solAmount.toFixed(4)} SOL</div>
          <div>Price: ${swap.price.toFixed(12)}</div>
        </div>
      `;
      
      tradeList.insertBefore(tradeItem, tradeList.firstChild);
      
      // Remove 'new' class after animation
      setTimeout(() => tradeItem.classList.remove('new'), 300);
      
      // Keep only last 50 in DOM
      while (tradeList.children.length > 50) {
        tradeList.removeChild(tradeList.lastChild);
      }
    }
    
    function calculateRSI(candles, period) {
      if (candles.length < period + 1) return candles.map(c => ({ time: c.time, value: 50 }));
      
      const rsi = [];
      const changes = [];
      
      for (let i = 1; i < candles.length; i++) {
        changes.push(candles[i].close - candles[i - 1].close);
      }
      
      for (let i = 0; i < candles.length; i++) {
        if (i < period) {
          rsi.push({ time: candles[i].time, value: 50 });
          continue;
        }
        
        const slice = changes.slice(i - period, i);
        const gains = slice.filter(c => c > 0).reduce((sum, c) => sum + c, 0) / period;
        const losses = Math.abs(slice.filter(c => c < 0).reduce((sum, c) => sum + c, 0)) / period;
        
        const rs = losses === 0 ? 100 : gains / losses;
        const rsiValue = 100 - (100 / (1 + rs));
        
        rsi.push({ time: candles[i].time, value: rsiValue });
      }
      
      return rsi;
    }
    
    function switchTimeframe(tf) {
      currentTimeframe = tf;
      document.querySelectorAll('.tf-btn').forEach(btn => btn.classList.remove('active'));
      event.target.classList.add('active');
      
      setChartData(tf);
    }
    
    // Mock data for testing
    function loadMockData() {
      updateProgress(10, 'Fetching metadata...');
      
      setTimeout(() => {
        showTokenInfo({
          name: '1 meme can change your life',
          symbol: '1MEME',
          image: null
        });
        
        updateProgress(30, 'Extracting bonding curve...');
        
        setTimeout(() => {
          updateProgress(50, 'Parsing transactions...');
          
          setTimeout(() => {
            updateProgress(80, 'Building candles...');
            
            setTimeout(() => {
              updateProgress(100, 'Complete!');
              
              // Generate mock candles
              const now = Math.floor(Date.now() / 1000);
              const mockCandles = [];
              
              for (let i = 0; i < 100; i++) {
                const time = now - (100 - i) * 60;
                const open = 0.00000005 + Math.random() * 0.00000002;
                const high = open + Math.random() * 0.00000001;
                const low = open - Math.random() * 0.00000001;
                const close = low + Math.random() * (high - low);
                const volume = Math.random() * 5;
                
                mockCandles.push({ time, open, high, low, close, volume });
              }
              
              allCandles['1m'] = mockCandles;
              allCandles['5m'] = mockCandles;
              allCandles['15m'] = mockCandles;
              
              initializeCharts(mockCandles);
              
              // Simulate live updates
              setInterval(() => {
                const lastCandle = mockCandles[mockCandles.length - 1];
                const newPrice = lastCandle.close * (1 + (Math.random() - 0.5) * 0.02);
                
                const updatedCandle = {
                  ...lastCandle,
                  high: Math.max(lastCandle.high, newPrice),
                  low: Math.min(lastCandle.low, newPrice),
                  close: newPrice,
                  volume: lastCandle.volume + Math.random() * 0.5
                };
                
                mockCandles[mockCandles.length - 1] = updatedCandle;
                updateCandle('1m', updatedCandle);
                
                // Random trade
                if (Math.random() > 0.7) {
                  addTrade({
                    timestamp: Math.floor(Date.now() / 1000),
                    type: Math.random() > 0.5 ? 'buy' : 'sell',
                    price: newPrice,
                    tokenAmount: Math.random() * 1000,
                    solAmount: Math.random() * 2,
                    tags: Math.random() > 0.8 ? ['LARGE_BUY'] : undefined
                  });
                }
              }, 2000);
            }, 500);
          }, 500);
        }, 500);
      }, 500);
    }
    
    // Start
    connect();
  </script>
</body>
</html>
